<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Particles</title>
    </head>
    <body>
        <canvas id="canvas"></canvas>
        <script type="module">

import init, { Particles } from './wasm/examples.js';
import createScreen from './screen.js';
import { addBrushListener, removeBrushListener } from './brush.js';

let screen;
let app;
let time;
let brush;

async function main() {
    const wasm = await init();
    screen = createScreen(wasm.memory, document.querySelector('#canvas'));
    app = Particles.new();
    time = Date.now();

    screen.draw(app.render());
    requestAnimationFrame(loop);

    addBrushListener(document.querySelector('#canvas'), onBrush);
}

function loop() {
    const now = Date.now();
    app.step((now - time) / 1000);
    time = now;
    screen.draw(app.render());
    drawOverlay();
    requestAnimationFrame(loop);
}

function onBrush(nextBrush) {
    if (nextBrush.phase === 'end') {
        app.burst(brush.initialX, brush.initialY, -brush.extentX, -brush.extentY);
        brush = null;
    } else {
        brush = nextBrush;
    }
}

function drawOverlay() {
    if (!brush) {
        return;
    }
    let context = document.querySelector('#canvas').getContext('2d');
    context.save();
    context.globalAlpha = 0.2;
    context.beginPath();
    context.moveTo(brush.initialX, brush.initialY);
    context.lineTo(brush.initialX + brush.extentX, brush.initialY + brush.extentY);
    context.stroke();
    context.restore();
}

main();

        </script>
    </body>
</html>
